<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script type="text/javascript" src="js/web3.min.js"></script>
<script type="text/javascript" src="js/init.js"></script>
<script>
 var address = "0x42e835aa2030363e4580ebe5f69e4f20bdfa5c85";
window.addEventListener('load', function() {
   web3 = new Web3(Web3.givenProvider);
   // Checking if Web3 has been injected by the browser (Mist/MetaMask)
   if (typeof web3 !== 'undefined') {

     // Use the browser's ethereum provider
     var provider = web3.currentProvider
     //console.log("ok");

   } else {
     console.log('No web3? You should consider trying MetaMask!')
   }
 });
var contract = web3.eth.contract(abi).at(address);
var myEvent = contract.MyEvent({});
init();
function init(){
  contract.getPlayer1Status(function(error,result){
    if(result==0){
      document.getElementById("joinButton").disabled = false;
    }else{
      contract.getPlayer2Status(function(error,result){
        if(result==0){
          document.getElementById("joinAndPlayButton").disabled = false;
        }else{
          document.getElementById("playButton").disabled = false;
        }
      })
    }
  })

}

myEvent.watch(
  function(error,result){
    if(!error){
      console.log(result.args.result);
    }else{
      console.error(error);
    }
  }
);

function join(){
  var plaintext =document.forms[0].myChoise.value;
  plaintext = web3.utils.asciiToHex(plaintext);
  plaintext+="00000000000000000000000000000000000000000000000000000000000000";
  var ciphertext = web3.utils.keccak256(plaintext);
  var bet = document.forms[0].bet.value;
  contract.join(ciphertext,{value:web3.utils.toWei(bet,"ether")},function(error,result){
    if(!error){
      //console.log(result);
      }else{
        console.error(error);
      }
    })
}

function joinAndPlay(){
  var plaintext =document.forms[0].myChoise.value;
  plaintext = web3.utils.asciiToHex(plaintext);
  plaintext+="00000000000000000000000000000000000000000000000000000000000000";
  var bet = document.forms[0].bet.value;
    contract.joinAndPlay(plaintext,{value:web3.utils.toWei(bet,"ether")},function(error,result){
      if(!error){
        //console.log(result);
      }else{
        console.error(error);
      }
    })
}
function play(){
  var plaintext =document.forms[0].myChoise.value;
  plaintext = web3.utils.asciiToHex(plaintext);
  plaintext+="00000000000000000000000000000000000000000000000000000000000000";
    contract.play(plaintext,{gas:99999},function(error,result){
      if(!error){
        //console.log(result);
      }else{
        console.error(error);
      }
    })
}
</script>
</head>
<body>
<form>
  <input type="radio" name="myChoise" value="1" checked>剪刀</input>
  <input type="radio" name="myChoise" value="2">石头</input>
  <input type="radio" name="myChoise" value="3">布</input>
  <br/>
<input type="number" name="bet" value="5"></input>
<br/>
</form>
<button id="joinButton"  onclick="join()" disabled=disabled>start</button>
<button id="playButton"  onclick="play()" disabled=disabled>play</button>
<button id="joinAndPlayButton"  onclick="joinAndPlay()" disabled=disabled>startAndPlay</button>
</body>
</html>
